<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Legal Bot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #000000;
      --sidebar-bg: #000000;
      --text-color: #ececf1;
      --secondary-text: #9b9b9b;
      --input-bg: #1e1e1e; /* Slightly lighter for input */
      --user-msg-bg: #1e1e1e;
      --assistant-msg-bg: transparent;
      --border-color: #333;
      --accent-color: #3b82f6; /* Blueish */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Minimal Header */
    .header {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: center; /* Center title */
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 100;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
    }

    .header-title {
      font-size: 15px;
      font-weight: 500;
      color: #a1a1aa;
    }

    /* Main Chat Area */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 80px 24px 120px; /* Top padding for header, bottom for input */
      display: flex;
      flex-direction: column;
      gap: 0px; /* No gap, messages handle their own padding */
      max-width: 768px; /* Start narrow like ChatGPT */
      margin: 0 auto;
      width: 100%;
      scroll-behavior: smooth;
    }
    
    .chat-container::-webkit-scrollbar { width: 6px; }
    .chat-container::-webkit-scrollbar-track { background: transparent; }
    .chat-container::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* Empty State / Watermark */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #333;
      user-select: none;
      opacity: 0;
      animation: fadeInSlow 1s forwards;
    }

    @keyframes fadeInSlow {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .empty-state h1 {
      font-size: 24px;
      font-weight: 500;
      color: #333; /* Very subtle */
      margin-top: -60px;
    }

    /* Messages */
    .message {
      display: flex;
      gap: 16px;
      padding: 24px 0;
      width: 100%;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 16px;
      margin-top: 2px;
    }
    
    .message.user .message-avatar {
      background: #333;
      border-radius: 50%;
    }
    
    .message.assistant .message-avatar {
      background: transparent;
      border: 1px solid #333;
      color: #fff;
      border-radius: 50%;
    }

    .message-content {
      flex: 1;
      line-height: 1.6;
      font-size: 15px;
      color: #e5e5e5;
    }

    .message.user .message-content {
      color: #fff;
      font-weight: 400;
    }

    /* Typography in messages */
    .message-content strong { color: #fff; font-weight: 600; }
    .message-content h3 { margin-top: 16px; margin-bottom: 8px; color: #fff; font-size: 16px; }
    .message-content p { margin-bottom: 12px; }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content ul { margin-left: 20px; margin-bottom: 12px; }
    .message-content li { margin-bottom: 4px; }
    .message-content code { background: #222; padding: 2px 5px; border-radius: 4px; font-size: 0.9em; font-family: monospace; }

    /* Sources */
    .sources-container {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    
    .sources-label {
      font-size: 11px;
      text-transform: uppercase;
      color: #555;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .source-tag {
      display: inline-block;
      font-size: 12px;
      color: #888;
      background: rgba(255,255,255,0.03);
      padding: 4px 8px;
      border-radius: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
      border: 1px solid rgba(255,255,255,0.05);
      transition: all 0.2s;
    }
    
    .source-tag:hover {
      background: rgba(255,255,255,0.08);
      color: #ccc;
    }

    /* Input Area */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 24px;
      background: linear-gradient(180deg, transparent 0%, var(--bg-color) 40%);
      display: flex;
      justify-content: center;
    }

    .input-wrapper {
      width: 100%;
      max-width: 768px;
      background: #18181b; /* Zinc 900 */
      border: 1px solid #27272a;
      border-radius: 26px; /* Rounded pill shape */
      display: flex;
      align-items: flex-end;
      padding: 10px 16px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      transition: border-color 0.2s;
    }

    .input-wrapper:focus-within {
      border-color: #3f3f46;
    }

    textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-family: inherit;
      font-size: 15px;
      resize: none;
      padding: 8px 0;
      max-height: 200px;
      outline: none;
      line-height: 1.5;
    }
    
    textarea::placeholder { color: #52525b; }

    .send-btn {
      background: #333;
      color: #fff;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 10px;
      margin-bottom: 4px;
      transition: all 0.2s;
    }
    
    .send-btn:hover:not(:disabled) { background: #fff; color: #000; }
    .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    
    .send-btn svg { width: 16px; height: 16px; fill: currentColor; }

    /* Loading dots */
    .typing-indicator span {
      display: inline-block;
      width: 5px;
      height: 5px;
      margin-right: 3px;
      background: #888;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-title">Legal Bot</div>
  </div>

  <div class="chat-container" id="chatContainer">
    <div id="emptyState" class="empty-state">
      <h1>Legal Bot</h1>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrapper">
      <textarea 
        id="userInput" 
        rows="1" 
        placeholder="Message Legal Bot..." 
        oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 200) + 'px'"
        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
      ></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const emptyState = document.getElementById('emptyState');
    let isProcessing = false;

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text || isProcessing) return;
      
      isProcessing = true;
      sendBtn.disabled = true;
      userInput.value = '';
      userInput.style.height = 'auto';
      
      // Hide empty state
      if(emptyState) emptyState.style.display = 'none';

      // Add User Message
      appendMessage('user', text);

      // Add Loading State
      const loadingId = appendLoading();

      try {
        const response = await fetch(`/api/query/search?q=${encodeURIComponent(text)}`);
        const data = await response.json();
        
        removeMessage(loadingId);
        
        if (data.success && data.data) {
          const answer = data.data.antwort || data.data.answer || "I couldn't find an answer.";
          const sources = data.data.quellen || data.data.sources || [];
          appendMessage('assistant', answer, sources);
        } else {
          appendMessage('assistant', 'Sorry, something went wrong.');
        }
      } catch (e) {
        removeMessage(loadingId);
        appendMessage('assistant', 'Network error. Please try again.');
        console.error(e);
      }

      isProcessing = false;
      sendBtn.disabled = false;
      userInput.focus();
    }

    function appendMessage(role, text, sources = []) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.innerHTML = role === 'user' 
        ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>'
        : '⚖️';

      const content = document.createElement('div');
      content.className = 'message-content';
      
      // Format text
      let formatted = text
        .replace(/\n\n/g, '<p><br></p>')
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^- (.*$)/gim, '<li>$1</li>');
      
      if (formatted.includes('<li>')) {
          formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
      }

      content.innerHTML = `<div>${formatted}</div>`;

      if (sources && sources.length > 0) {
        const sourceDiv = document.createElement('div');
        sourceDiv.className = 'sources-container';
        sourceDiv.innerHTML = `<div class="sources-label">Sources</div>`;
        sources.slice(0, 4).forEach(s => {
          const tag = document.createElement('span');
          tag.className = 'source-tag';
          tag.textContent = (s.law_code || 'BGB') + ' ' + (s.paragraph_number || '§');
          sourceDiv.appendChild(tag);
        });
        content.appendChild(sourceDiv);
      }

      div.appendChild(avatar);
      div.appendChild(content);
      chatContainer.appendChild(div);
      
      // Scroll to bottom
      window.scrollTo(0, document.body.scrollHeight);
      return div.id;
    }

    function appendLoading() {
      const id = 'msg-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = 'message assistant';
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = '⚖️';

      const content = document.createElement('div');
      content.className = 'message-content typing-indicator';
      content.innerHTML = '<span></span><span></span><span></span>';

      div.appendChild(avatar);
      div.appendChild(content);
      chatContainer.appendChild(div);
      window.scrollTo(0, document.body.scrollHeight);
      return id;
    }

    function removeMessage(id) {
      const el = document.getElementById(id);
      if(el) el.remove();
    }
  </script>
</body>
</html>
